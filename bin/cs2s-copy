#!/usr/bin/python3.11

from __future__ import annotations

import argparse
import shutil
import sys
from pathlib import Path

STEAM_USER = STEAM_GROUP = "steam"
CS2_SUBPATH = Path("game/csgo")


def main() -> int:
    """Copy files into a CS2 installation."""

    parser = argparse.ArgumentParser(description=main.__doc__)
    parser.add_argument(
        "path",
        type=Path,
        help="An install path; will fall back to overlays.",
    )
    parser.add_argument(
        "package",
        type=Path,
        nargs="?",
        default="package",
        help="The directory structure to copy into the installation. Defaults to 'package'."
    )
    args = parser.parse_args()

    if not args.package.is_dir():
        print(f"Package {args.package} is not a directory!", file=sys.stderr)
        return 1

    if args.path.is_dir():
        destination = args.path.absolute() / CS2_SUBPATH
        overlay = False
        print(f"Copying {args.package} into {destination}")
    else:
        args.path = Path("/home/steam") / args.path
        if not args.path.is_dir():
            print(f"Couldn't resolve package {args.path}", file=sys.stderr)
            return 1
        destination = args.path / CS2_SUBPATH
        overlay = True
        print(f"Copying {args.package} into overlay {destination}")

    shutil.copytree(args.package, destination, dirs_exist_ok=True)

    if overlay:
        print("Fixing overlay owner and permissions")
        shutil.chown(destination, user=STEAM_USER, group=STEAM_GROUP)


if __name__ == "__main__":
    exit(main())
